<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>X-ORBIT Status</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/qmOv0qw.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: #0a0a0f;
        color: #f8f9fa;
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Background Effects */
      .cosmic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        background: radial-gradient(
            circle at 20% 80%,
            #1a0d2e 0%,
            transparent 50%
          ),
          radial-gradient(circle at 80% 20%, #2d1b69 0%, transparent 50%),
          linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
      }

      .grid-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(255, 255, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.03) 1px,
            transparent 1px
          );
        background-size: 50px 50px;
        opacity: 0.3;
        z-index: -1;
        pointer-events: none;
      }

      /* Container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 3rem 0 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 3rem;
      }

      .logo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(
            135deg,
            rgba(147, 51, 234, 0.2) 0%,
            rgba(0, 212, 255, 0.2) 100%
          ),
          url("https://codehs.com/uploads/ab65fa0acacaff18144310e79cb0895f")
            no-repeat center center;
        background-size: cover;
        margin: 0 auto 1.5rem;
        border: 3px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 40px rgba(147, 51, 234, 0.4);
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #9333ea 0%, #00d4ff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .header p {
        color: #94a3b8;
        font-size: 1.1rem;
      }

      /* Overall Status Banner */
      .overall-status {
        background: rgba(15, 15, 35, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 3rem;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .overall-status::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #10b981, #34d399);
      }

      .overall-status.degraded::before {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }

      .overall-status.outage::before {
        background: linear-gradient(90deg, #ef4444, #dc2626);
      }

      .overall-status.maintenance::before {
        background: linear-gradient(90deg, #fbbf24, #facc15);
      }

      .overall-status.unknown::before {
        background: linear-gradient(90deg, #6b7280, #9ca3af);
      }

      .status-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        background: linear-gradient(135deg, #10b981, #34d399);
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
        animation: pulse 2s ease-in-out infinite;
      }

      .overall-status.degraded .status-icon {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
      }

      .overall-status.outage .status-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
      }

      .overall-status.maintenance .status-icon {
        background: linear-gradient(135deg, #fbbf24, #facc15);
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.4);
      }

      .overall-status.unknown .status-icon {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
        box-shadow: 0 0 30px rgba(107, 114, 128, 0.4);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .status-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #10b981;
      }

      .overall-status.degraded .status-title {
        color: #fbbf24;
      }

      .overall-status.outage .status-title {
        color: #ef4444;
      }

      .overall-status.maintenance .status-title {
        color: #fbbf24;
      }

      .overall-status.unknown .status-title {
        color: #9ca3af;
      }

      .status-subtitle {
        color: #94a3b8;
        font-size: 1rem;
      }

      /* Incident Banner */
      .incident-banner {
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-left: 4px solid #fbbf24;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: none;
      }

      .incident-banner.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      .incident-banner.critical {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        border-left-color: #ef4444;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .incident-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .incident-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #fbbf24, #facc15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }

      .incident-banner.critical .incident-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }

      .incident-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #fbbf24;
      }

      .incident-banner.critical .incident-title {
        color: #fca5a5;
      }

      .incident-message {
        color: #e2e8f0;
        line-height: 1.6;
        margin-left: 2.5rem;
      }

      .incident-time {
        color: #94a3b8;
        font-size: 0.9rem;
        margin-left: 2.5rem;
        margin-top: 0.5rem;
      }

      /* Services Section */
      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #9333ea, #00d4ff);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .services-grid {
        display: grid;
        gap: 1rem;
        margin-bottom: 3rem;
      }

      .service-card {
        background: rgba(15, 15, 35, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
      }

      .service-card:hover {
        background: rgba(15, 15, 35, 0.8);
        border-color: rgba(147, 51, 234, 0.3);
        transform: translateX(5px);
      }

      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .service-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .service-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.2),
          rgba(0, 212, 255, 0.2)
        );
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #9333ea;
        flex-shrink: 0;
      }

      .service-details h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .service-description {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .service-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .service-status.operational {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .service-status.degraded {
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }

      .service-status.outage {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .service-status.maintenance {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
      }

      .service-status.unknown {
        background: rgba(107, 114, 128, 0.15);
        color: #9ca3af;
        border: 1px solid rgba(107, 114, 128, 0.3);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s ease-in-out infinite;
      }

      /* Components List */
      .components-list {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: grid;
        gap: 0.5rem;
      }

      .component-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .component-name {
        color: #cbd5e1;
      }

      .component-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .component-status.operational {
        color: #10b981;
      }

      .component-status.degraded {
        color: #fbbf24;
      }

      .component-status.outage {
        color: #ef4444;
      }

      .component-status.maintenance {
        color: #fbbf24;
      }

      .component-status.unknown {
        color: #9ca3af;
      }

      .component-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
      }

      /* Uptime Stats */
      .uptime-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      .uptime-card {
        background: rgba(15, 15, 35, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .uptime-card:hover {
        background: rgba(15, 15, 35, 0.8);
        border-color: rgba(147, 51, 234, 0.3);
        transform: translateY(-5px);
      }

      .uptime-value {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #10b981, #34d399);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
      }

      .uptime-label {
        color: #94a3b8;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Recent Incidents */
      .incidents-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .incident-card {
        background: rgba(15, 15, 35, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid #fbbf24;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
      }

      .incident-card.resolved {
        border-left-color: #10b981;
        opacity: 0.7;
      }

      .incident-card:hover {
        background: rgba(15, 15, 35, 0.8);
        opacity: 1;
      }

      .incident-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
      }

      .incident-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #f8f9fa;
      }

      .incident-status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .incident-status-badge.investigating {
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }

      .incident-status-badge.resolved {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .incident-card-message {
        color: #cbd5e1;
        line-height: 1.6;
        margin-bottom: 0.75rem;
      }

      .incident-card-footer {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #94a3b8;
        font-size: 0.85rem;
      }

      .incident-service {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #10b981;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 2rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 3rem;
        color: #94a3b8;
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .footer-link {
        color: #00d4ff;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .footer-link:hover {
        color: #38bdf8;
      }

      .last-updated {
        font-size: 0.85rem;
        margin-top: 0.5rem;
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 4rem;
        color: #94a3b8;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(147, 51, 234, 0.2);
        border-top: 4px solid #9333ea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        .header h1 {
          font-size: 2rem;
        }

        .service-card {
          padding: 1rem;
        }

        .service-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .service-status {
          width: 100%;
          justify-content: center;
        }

        .uptime-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="cosmic-bg"></div>
    <div class="grid-overlay"></div>

    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="logo"></div>
        <h1>X-ORBIT Status</h1>
        <p>Real-time system status and uptime monitoring</p>
      </div>

      <!-- Overall Status Banner -->
      <div class="overall-status" id="overallStatus">
        <div class="status-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 class="status-title">All Systems Operational</h2>
        <p class="status-subtitle">All services are running smoothly</p>
      </div>

      <!-- Active Incident Banner -->
      <div class="incident-banner" id="incidentBanner">
        <div class="incident-header">
          <div class="incident-icon">
            <i class="fas fa-tools"></i>
          </div>
          <div class="incident-title" id="bannerTitle">Incident Title</div>
        </div>
        <div class="incident-message" id="bannerMessage">
          Incident description
        </div>
        <div class="incident-time" id="bannerTime">
          Status: Investigating
        </div>
      </div>

      <!-- Services Status -->
      <div class="section-title">
        <div class="section-icon">
          <i class="fas fa-server"></i>
        </div>
        Service Status
      </div>

      <div class="services-grid" id="servicesGrid">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>

      <!-- Uptime Statistics -->
      <div class="section-title">
        <div class="section-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        Uptime Statistics
      </div>

      <div class="uptime-grid">
        <div class="uptime-card">
          <div class="uptime-value" id="uptime24h">99.99%</div>
          <div class="uptime-label">24 Hours</div>
        </div>
        <div class="uptime-card">
          <div class="uptime-value" id="uptime7d">99.95%</div>
          <div class="uptime-label">7 Days</div>
        </div>
        <div class="uptime-card">
          <div class="uptime-value" id="uptime30d">99.90%</div>
          <div class="uptime-label">30 Days</div>
        </div>
        <div class="uptime-card">
          <div class="uptime-value" id="uptime90d">99.85%</div>
          <div class="uptime-label">90 Days</div>
        </div>
      </div>

      <!-- Recent Incidents -->
      <div class="section-title">
        <div class="section-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        Recent Incidents
      </div>

      <div class="incidents-list" id="incidentsList">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div class="footer-links">
          <a href="https://xorbit.org" class="footer-link">
            <i class="fas fa-home"></i> Main Site
          </a>
          <a href="https://xorbit.org/support" class="footer-link">
            <i class="fas fa-life-ring"></i> Support
          </a>
          <a href="https://xorbit.org/admin/dashboard" class="footer-link">
            <i class="fas fa-shield-halved"></i> Admin
          </a>
        </div>
        <p>&copy; 2025 X-ORBIT. All rights reserved.</p>
        <p class="last-updated">
          Last updated: <span id="lastUpdated">Loading...</span>
        </p>
      </div>
    </div>

    <script>
      let supabaseClient = null;
      let supabaseAvailable = false;

      // Initialize Supabase
      async function initSupabase() {
        try {
          let attempts = 0;
          while (!window.supabase && attempts < 10) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          if (!window.supabase) {
            console.error("Supabase library failed to load");
            return false;
          }

          const SUPABASE_URL = "https://rujvmtvozorylfzsqppc.supabase.co";
          const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY";

          supabaseClient = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );

          // Test connection
          const { error } = await supabaseClient
            .from("status_info")
            .select("count")
            .limit(1);

          if (error) {
            console.error("Supabase connection test failed:", error);
            return false;
          }

          console.log("✅ Supabase initialized and connected");
          supabaseAvailable = true;
          return true;
        } catch (error) {
          console.error("❌ Supabase initialization failed:", error);
          return false;
        }
      }

      // Load services status from Supabase
      async function loadServices() {
        const servicesGrid = document.getElementById("servicesGrid");

        try {
          if (!supabaseClient || !supabaseAvailable) {
            throw new Error("Supabase not available");
          }

          // Load services
          const { data: services, error: servicesError } = await supabaseClient
            .from("status_info")
            .select("*")
            .order("priority", { ascending: true });

          if (servicesError) {
            console.error("Error fetching services:", servicesError);
            throw servicesError;
          }

          // Load components
          const { data: components, error: componentsError } = await supabaseClient
            .from("service_components")
            .select("*")
            .order("priority", { ascending: true });

          if (componentsError) {
            console.error("Error fetching components:", componentsError);
          }

          // Map components to their parent services
          const componentsMap = {};
          if (components) {
            components.forEach((comp) => {
              if (!componentsMap[comp.parent_service_id]) {
                componentsMap[comp.parent_service_id] = [];
              }
              componentsMap[comp.parent_service_id].push(comp);
            });
          }

          const servicesWithComponents = services.map((service) => ({
            ...service,
            components: componentsMap[service.service_id] || [],
          }));

          displayServices(servicesWithComponents);
          updateOverallStatus(servicesWithComponents);

          if (servicesWithComponents[0]?.uptime_24h !== undefined) {
            updateUptimeStats(servicesWithComponents);
          }
        } catch (error) {
          console.error("Error loading services:", error);
          handleSupabaseFailure();
        }
      }

      // Handle Supabase connection failure
      function handleSupabaseFailure() {
        console.warn("⚠️ Supabase unavailable - marking database as down and others as unknown");
        
        const fallbackServices = [
          {
            service_id: "web-dashboard",
            service_name: "Web Dashboard",
            service_description: "Main X-ORBIT dashboard interface",
            service_icon: "fa-globe",
            status: "unknown",
            components: [],
          },
          {
            service_id: "proxy-browser",
            service_name: "Proxy Browser",
            service_description: "Rammerhead & Ultraviolet proxy services",
            service_icon: "fa-browser",
            status: "unknown",
            components: [],
          },
          {
            service_id: "authentication",
            service_name: "Authentication",
            service_description: "Login and user authentication system",
            service_icon: "fa-shield-halved",
            status: "unknown",
            components: [],
          },
          {
            service_id: "api-services",
            service_name: "API Services",
            service_description: "Backend API and database connections",
            service_icon: "fa-code",
            status: "unknown",
            components: [],
          },
          {
            service_id: "support-portal",
            service_name: "Support Portal",
            service_description: "Ticket system and support center",
            service_icon: "fa-life-ring",
            status: "unknown",
            components: [],
          },
          {
            service_id: "database",
            service_name: "Database",
            service_description: "Supabase PostgreSQL database",
            service_icon: "fa-database",
            status: "outage",
            components: [],
          },
        ];

        displayServices(fallbackServices);
        updateOverallStatus(fallbackServices);

        // Show banner
        const banner = document.getElementById("incidentBanner");
        const bannerTitle = document.getElementById("bannerTitle");
        const bannerMessage = document.getElementById("bannerMessage");
        const bannerTime = document.getElementById("bannerTime");

        bannerTitle.textContent = "Database Connection Issue";
        bannerMessage.textContent = "Unable to connect to the status database. Service status information may be outdated or unavailable.";
        bannerTime.textContent = "Status: Investigating";
        banner.classList.add("show", "critical");
      }

      // Display services with components
      function displayServices(services) {
        const servicesGrid = document.getElementById("servicesGrid");

        servicesGrid.innerHTML = services
          .map((service) => {
            const componentsHTML = service.components?.length
              ? `
              <div class="components-list">
                ${service.components
                  .map(
                    (comp) => `
                  <div class="component-item">
                    <span class="component-name">${comp.component_name}</span>
                    <div class="component-status ${comp.status}">
                      <span class="component-dot"></span>
                      ${formatStatus(comp.status)}
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            `
              : "";

            return `
            <div class="service-card">
              <div class="service-header">
                <div class="service-info">
                  <div class="service-icon">
                    <i class="fas ${service.service_icon}"></i>
                  </div>
                  <div class="service-details">
                    <h3>${service.service_name}</h3>
                    <p class="service-description">${service.service_description}</p>
                  </div>
                </div>
                <div class="service-status ${service.status}">
                  <span class="status-dot"></span>
                  ${formatStatus(service.status)}
                </div>
              </div>
              ${componentsHTML}
            </div>
          `;
          })
          .join("");
      }

      // Format status text
      function formatStatus(status) {
        const statusMap = {
          operational: "Operational",
          degraded: "Degraded",
          outage: "Outage",
          maintenance: "Maintenance",
          unknown: "Unknown",
        };
        return statusMap[status] || "Unknown";
      }

      // Update overall status
      function updateOverallStatus(services) {
        const overallStatus = document.getElementById("overallStatus");
        const statusIcon = overallStatus.querySelector(".status-icon i");
        const statusTitle = overallStatus.querySelector(".status-title");
        const statusSubtitle = overallStatus.querySelector(".status-subtitle");

        const hasOutage = services.some((s) => s.status === "outage");
        const hasDegraded = services.some((s) => s.status === "degraded");
        const hasMaintenance = services.some((s) => s.status === "maintenance");
        const hasUnknown = services.some((s) => s.status === "unknown");

        if (hasOutage) {
          overallStatus.className = "overall-status outage";
          statusIcon.className = "fas fa-times-circle";
          statusTitle.textContent = "Service Disruption";
          statusSubtitle.textContent = "Some services are experiencing issues";
        } else if (hasMaintenance) {
          overallStatus.className = "overall-status maintenance";
          statusIcon.className = "fas fa-tools";
          statusTitle.textContent = "Scheduled Maintenance";
          statusSubtitle.textContent = "Some services are under maintenance";
        } else if (hasDegraded) {
          overallStatus.className = "overall-status degraded";
          statusIcon.className = "fas fa-exclamation-triangle";
          statusTitle.textContent = "Degraded Performance";
          statusSubtitle.textContent = "Some services may be running slower than normal";
        } else if (hasUnknown) {
          overallStatus.className = "overall-status unknown";
          statusIcon.className = "fas fa-question-circle";
          statusTitle.textContent = "Status Unknown";
          statusSubtitle.textContent = "Unable to determine current service status";
        } else {
          overallStatus.className = "overall-status";
          statusIcon.className = "fas fa-check-circle";
          statusTitle.textContent = "All Systems Operational";
          statusSubtitle.textContent = "All services are running smoothly";
        }
      }

      // Update uptime statistics from database
      function updateUptimeStats(services) {
        const avgUptime24h = services.reduce((sum, s) => sum + (s.uptime_24h || 100), 0) / services.length;
        const avgUptime7d = services.reduce((sum, s) => sum + (s.uptime_7d || 100), 0) / services.length;
        const avgUptime30d = services.reduce((sum, s) => sum + (s.uptime_30d || 100), 0) / services.length;
        const avgUptime90d = services.reduce((sum, s) => sum + (s.uptime_90d || 100), 0) / services.length;

        document.getElementById("uptime24h").textContent = avgUptime24h.toFixed(2) + "%";
        document.getElementById("uptime7d").textContent = avgUptime7d.toFixed(2) + "%";
        document.getElementById("uptime30d").textContent = avgUptime30d.toFixed(2) + "%";
        document.getElementById("uptime90d").textContent = avgUptime90d.toFixed(2) + "%";
      }

      // Load active incidents
      async function loadIncidents() {
        const incidentsList = document.getElementById("incidentsList");
        const incidentBanner = document.getElementById("incidentBanner");

        try {
          if (!supabaseClient || !supabaseAvailable) {
            throw new Error("Supabase not available");
          }

          const { data: incidents, error } = await supabaseClient
            .from("incidents")
            .select("*")
            .eq("is_active", true)
            .order("created_at", { ascending: false })
            .limit(10);

          if (error) {
            console.error("Error fetching incidents:", error);
            throw error;
          }

          if (incidents && incidents.length > 0) {
            // Show banner if any incident has show_banner = true
            const bannerIncident = incidents.find((i) => i.show_banner);
            if (bannerIncident) {
              displayIncidentBanner(bannerIncident);
            }

            displayIncidents(incidents);
          } else {
            incidentsList.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <p>No recent incidents reported</p>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error loading incidents:", error);
          incidentsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Unable to load incident history</p>
            </div>
          `;
        }
      }

      // Display incident banner
      function displayIncidentBanner(incident) {
        const banner = document.getElementById("incidentBanner");
        const bannerTitle = document.getElementById("bannerTitle");
        const bannerMessage = document.getElementById("bannerMessage");
        const bannerTime = document.getElementById("bannerTime");

        bannerTitle.textContent = incident.title;
        bannerMessage.textContent = incident.description;
        bannerTime.textContent = `Status: ${incident.status.charAt(0).toUpperCase() + incident.status.slice(1)}`;

        if (incident.severity === "critical") {
          banner.classList.add("critical");
        }

        banner.classList.add("show");
      }

      // Display incidents
      function displayIncidents(incidents) {
        const incidentsList = document.getElementById("incidentsList");

        incidentsList.innerHTML = incidents
          .map(
            (incident) => `
          <div class="incident-card ${incident.status === "resolved" ? "resolved" : ""}">
            <div class="incident-card-header">
              <div class="incident-card-title">${incident.title}</div>
              <div class="incident-status-badge ${incident.status}">
                ${incident.status}
              </div>
            </div>
            <div class="incident-card-message">${incident.description}</div>
            <div class="incident-card-footer">
              <div class="incident-service">
                <i class="fas fa-server"></i>
                ${incident.affected_services === "all" ? "All Services" : incident.affected_services}
              </div>
              <div>
                <i class="far fa-clock"></i>
                ${formatDate(incident.created_at)}
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
      }

      // Update last updated time
      function updateLastUpdated() {
        const lastUpdated = document.getElementById("lastUpdated");
        const now = new Date();
        lastUpdated.textContent = now.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "numeric",
          minute: "2-digit",
          timeZone: "America/Denver",
          timeZoneName: "short",
        });
      }

      // Initialize
      async function init() {
        const supabaseReady = await initSupabase();
        
        if (supabaseReady) {
          await loadServices();
          await loadIncidents();
        } else {
          handleSupabaseFailure();
        }

        updateLastUpdated();

        // Auto-refresh every 30 seconds
        setInterval(async () => {
          if (supabaseAvailable) {
            await loadServices();
            await loadIncidents();
          }
          updateLastUpdated();
        }, 30000);
      }

      // Start when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
